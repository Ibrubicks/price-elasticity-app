<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pricing Intelligence Suite</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-body: #0b0e14;
            --bg-card: #151a23;
            --bg-input: #1e2532;
            --text-main: #f0f6fc;
            --text-muted: #8b949e;
            --border: #30363d;
            --accent: #3b82f6; 
            --accent-glow: rgba(59, 130, 246, 0.2);
            --success: #238636;
            --warning: #d29922;
            --danger: #f85149;
            --gradient-1: linear-gradient(135deg, rgba(59,130,246,0.1) 0%, rgba(15,23,42,0) 100%);
        }

        * { box-sizing: border-box; transition: all 0.2s ease-in-out; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); font-size: 14px; overflow-x: hidden; }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .grid { display: grid; grid-template-columns: 320px 1fr; gap: 25px; }
        @media (max-width: 1000px) { .grid { grid-template-columns: 1fr; } }

        h1, h2, h3 { margin: 0; }
        .text-sm { font-size: 0.85rem; color: var(--text-muted); }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; }
        
        .nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
        .brand { font-size: 1.3rem; font-weight: 700; background: linear-gradient(90deg, #fff, #8b949e); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .card:hover { border-color: var(--text-muted); }

        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; color: var(--text-muted); font-size: 0.8rem; font-weight: 500; }
        input, select { width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: var(--text-main); padding: 10px; border-radius: 6px; outline: none; }
        input:focus { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-glow); }

        .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; display: flex; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { filter: brightness(1.1); }
        .loader { width: 16px; height: 16px; border: 2px solid #fff; border-bottom-color: transparent; border-radius: 50%; animation: rot 1s linear infinite; display: none; }
        @keyframes rot { to { transform: rotate(360deg); } }

        .metrics-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px; }
        .metric-card { background: var(--bg-card); padding: 15px; border-radius: 8px; border: 1px solid var(--border); position: relative; overflow: hidden; }
        .metric-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--accent); }
        .metric-val { font-size: 1.6rem; font-weight: 700; margin: 5px 0; }

        .sim-box { background: var(--gradient-1); border: 1px solid var(--accent); margin-top: 20px; }
        input[type=range] { width: 100%; margin: 15px 0; accent-color: var(--accent); height: 4px; }
        .sim-val-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: center; }
        .sim-highlight { color: var(--accent); font-weight: 700; font-size: 1.1rem; }

        .conclusion { margin-top: 25px; border-top: 1px solid var(--border); padding-top: 20px; }
        
        /* NEW TABLES CSS */
        .summary-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85rem; }
        .summary-table th { text-align: left; border-bottom: 1px solid var(--border); padding: 8px; color: var(--text-muted); }
        .summary-table td { border-bottom: 1px solid var(--border); padding: 8px; color: var(--text-main); }
        .summary-row-highlight { background: rgba(59, 130, 246, 0.05); font-weight: 600; }
        .section-header { font-size: 0.9rem; font-weight: 600; margin-top: 20px; margin-bottom: 10px; color: var(--accent); text-transform: uppercase; letter-spacing: 0.5px; }
        .rec-text { line-height: 1.6; color: var(--text-main); font-size: 0.9rem; border-left: 3px solid var(--success); padding-left: 15px; margin-top: 10px; }

        .chart-container { height: 280px; position: relative; margin-top: 15px; }
    </style>
</head>
<body>

<div class="container">
    <nav class="nav">
        <div class="brand">Pricing Intelligence Suite</div>
        <div class="text-sm">Enterprise Edition</div>
    </nav>

    <div class="metrics-grid">
        <div class="metric-card">
            <div class="text-sm">Price Elasticity</div>
            <div class="metric-val" id="disp_elasticity">-</div>
        </div>
        <div class="metric-card">
            <div class="text-sm">Pricing Power</div>
            <div class="metric-val" id="disp_power">-</div>
        </div>
        <div class="metric-card">
            <div class="text-sm" id="opt_label">Max Potential</div>
            <div class="metric-val" style="color:var(--success)" id="disp_max">-</div>
        </div>
        <div class="metric-card">
            <div class="text-sm">Optimal Price</div>
            <div class="metric-val" id="disp_opt_price">-</div>
        </div>
    </div>

    <div class="grid">
        <div>
            <div class="card">
                <h3>Configuration</h3>
                <div style="height:15px"></div>
                
                <form id="configForm">
                    <div class="input-group">
                        <label>Sales Data (CSV)</label>
                        <input type="file" name="file" id="fileInput" accept=".csv" required>
                    </div>

                    <div class="input-group">
                        <label>Target Product</label>
                        <select name="product" id="productSelect" disabled>
                            <option value="ALL">All Products</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label>Unit Cost (Optional)</label>
                        <input type="number" name="cost" id="costInput" placeholder="0.00" step="0.01">
                        <div class="text-sm" style="margin-top:4px">Entering cost enables Profit Optimization</div>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <span>Run Analysis</span>
                        <div class="loader"></div>
                    </button>
                </form>

                <div class="card sim-box" id="simPanel" style="display:none;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>Simulator</h3>
                        <span class="badge" style="background:var(--accent); color:white">LIVE</span>
                    </div>
                    
                    <div style="margin: 15px 0;">
                        <div style="display:flex; justify-content:space-between; font-weight:600;">
                            <span>Price:</span>
                            <span id="simPriceVal" style="color:var(--accent)">-</span>
                        </div>
                        <input type="range" id="priceSlider">
                    </div>

                    <div class="sim-val-grid">
                        <div>
                            <div class="text-sm">Est. Volume</div>
                            <div id="simQty" class="sim-highlight">-</div>
                        </div>
                        <div>
                            <div class="text-sm" id="simMetricLabel">Est. Revenue</div>
                            <div id="simMetric" class="sim-highlight">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="volatilityBox" class="card" style="margin-top:20px; border-color:var(--danger); display:none;">
                <div style="display:flex; gap:10px; align-items:center; color:var(--danger); font-weight:700;">
                    <span>⚠️ High Volatility Detected</span>
                </div>
                <p class="text-sm" style="margin-top:10px">
                    Elasticity is > 1.5. Small price changes will cause massive volume swings. Proceed with caution.
                </p>
            </div>
        </div>

        <div>
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3>Demand Curve</h3>
                    <div class="text-sm">95% Confidence Band</div>
                </div>
                <div class="chart-container">
                    <canvas id="demandChart"></canvas>
                </div>
            </div>

            <div class="card" style="margin-top:20px">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3 id="metricChartTitle">Revenue Optimization</h3>
                    <div class="text-sm">Projected Performance</div>
                </div>
                <div class="chart-container">
                    <canvas id="metricChart"></canvas>
                </div>
            </div>

            <div class="card conclusion" id="conclusionPanel" style="display:none;">
                <h3>Executive Summary</h3>
                <!-- Content injected dynamically -->
            </div>
        </div>
    </div>
</div>

<script>
let model = { intercept: 0, elasticity: 0, cost: 0 };
let charts = { demand: null, metric: null };

document.getElementById('fileInput').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if(!file) return;
    const formData = new FormData();
    formData.append('file', file);
    const res = await fetch('/scan_products', { method:'POST', body:formData });
    const data = await res.json();
    const select = document.getElementById('productSelect');
    select.innerHTML = '<option value="ALL">All Products</option>';
    if(data.products && data.products.length > 0) {
        select.disabled = false;
        data.products.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p; opt.innerText = p; select.appendChild(opt);
        });
    }
});

document.getElementById('configForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = e.target.querySelector('button');
    const loader = e.target.querySelector('.loader');
    btn.disabled = true; loader.style.display = 'block';

    try {
        const formData = new FormData(e.target);
        const res = await fetch('/analyze', { method:'POST', body:formData });
        const data = await res.json();
        if(data.error) throw new Error(data.error);
        updateDashboard(data);
    } catch(err) {
        alert(err.message);
    } finally {
        btn.disabled = false; loader.style.display = 'none';
    }
});

function updateDashboard(data) {
    model = { intercept: data.optimization.intercept, elasticity: data.optimization.elasticity, cost: data.optimization.cost };
    const isProfit = model.cost > 0;
    const currency = '₹';

    animateValue('disp_elasticity', data.metrics.elasticity, '', 2);
    animateValue('disp_power', data.metrics.pricing_power, '', 0);
    animateValue('disp_opt_price', data.optimization.optimal_price, currency, 2);
    animateValue('disp_max', data.optimization.max_val, currency, 0);
    
    document.getElementById('opt_label').innerText = isProfit ? "Max Potential Profit" : "Max Potential Revenue";
    document.getElementById('metricChartTitle').innerText = isProfit ? "Profit Optimization" : "Revenue Optimization";
    document.getElementById('simMetricLabel').innerText = isProfit ? "Est. Profit" : "Est. Revenue";

    const volBox = document.getElementById('volatilityBox');
    volBox.style.display = Math.abs(data.metrics.elasticity) > 1.5 ? 'block' : 'none';

    const slider = document.getElementById('priceSlider');
    slider.min = data.charts.prices[0];
    slider.max = data.charts.prices[data.charts.prices.length - 1];
    slider.step = (slider.max - slider.min) / 100;
    slider.value = data.metrics.avg_price;
    document.getElementById('simPanel').style.display = 'block';
    updateSimulator(slider.value); 

    const panel = document.getElementById('conclusionPanel');
    panel.style.display = 'block';
    const imp = data.impact_analysis;
    const sens = data.sensitivity_analysis;
    const mkt = data.market_position;
    const scen = data.scenario_comparison;
    const risk = data.risk_simulation;

    let html = `
        <div class="section-header">Revenue Opportunity</div>
        <table class="summary-table">
            <tr><td>Current Performance</td><td>${currency}${imp.current_value.toLocaleString(undefined,{maximumFractionDigits:0})}</td></tr>
            <tr class="summary-row-highlight"><td>Optimal Potential</td><td>${currency}${imp.optimal_value.toLocaleString(undefined,{maximumFractionDigits:0})}</td></tr>
            <tr><td>Upside Value</td><td style="color:var(--success)">+${currency}${imp.absolute_gain.toLocaleString(undefined,{maximumFractionDigits:0})} (+${imp.percent_gain.toFixed(1)}%)</td></tr>
            ${isProfit ? `<tr><td>Target Margin</td><td>${imp.margin_percent.toFixed(1)}%</td></tr>` : ''}
        </table>

        <div class="section-header">Market Sensitivity</div>
        <div class="text-sm" style="margin-bottom:10px">${sens.demand_impact_statement}</div>
        <table class="summary-table">
            <tr><td>Volatility Profile</td><td>${sens.volatility_level}</td></tr>
            <tr><td>Confidence Score</td><td>${sens.confidence_level} (${(sens.confidence_score*100).toFixed(0)}%)</td></tr>
            <tr><td>Strategic Position</td><td>${mkt.strategic_positioning}</td></tr>
        </table>

        <div class="section-header">Scenario Comparison</div>
        <table class="summary-table">
            <thead><tr><th>Scenario</th><th>Price</th><th>Est. Vol</th><th>${isProfit ? 'Profit' : 'Revenue'}</th></tr></thead>
            <tbody>
                <tr><td>Current</td><td>${currency}${scen.current.price.toFixed(2)}</td><td>${Math.round(scen.current.volume)}</td><td>${currency}${Math.round(scen.current.metric).toLocaleString()}</td></tr>
                <tr class="summary-row-highlight"><td>Optimal</td><td>${currency}${scen.optimal.price.toFixed(2)}</td><td>${Math.round(scen.optimal.volume)}</td><td>${currency}${Math.round(scen.optimal.metric).toLocaleString()}</td></tr>
            </tbody>
        </table>

        <div class="section-header">Risk Sensitivity (Stress Test)</div>
        <div class="text-sm">
            Impact of 10% price deviation:
            <ul style="margin:5px 0 0 20px; padding:0;">
                <li>+10% Price: <span style="color:${risk.plus_10_percent_impact > 0 ? 'var(--success)' : 'var(--danger)'}">${risk.plus_10_percent_impact > 0 ? '+' : ''}${risk.plus_10_percent_impact.toFixed(1)}%</span> impact</li>
                <li>-10% Price: <span style="color:${risk.minus_10_percent_impact > 0 ? 'var(--success)' : 'var(--danger)'}">${risk.minus_10_percent_impact > 0 ? '+' : ''}${risk.minus_10_percent_impact.toFixed(1)}%</span> impact</li>
            </ul>
        </div>

        <div class="section-header">Final Strategic Recommendation</div>
        <div class="rec-text">${data.final_recommendation}</div>
    `;

    const contentContainer = document.createElement('div');
    contentContainer.innerHTML = html;
    const h3 = panel.querySelector('h3');
    panel.innerHTML = '';
    panel.appendChild(h3);
    panel.appendChild(contentContainer);

    renderCharts(data);
}

document.getElementById('priceSlider').addEventListener('input', (e) => updateSimulator(e.target.value));

function updateSimulator(price) {
    price = parseFloat(price);
    const logQ = model.intercept + (model.elasticity * Math.log(price));
    const q = Math.exp(logQ);
    const metric = model.cost > 0 ? (price - model.cost) * q : price * q;

    document.getElementById('simPriceVal').innerText = "₹" + price.toFixed(2);
    document.getElementById('simQty').innerText = Math.round(q).toLocaleString();
    document.getElementById('simMetric').innerText = "₹" + metric.toLocaleString(undefined, {maximumFractionDigits:0});

    if(charts.demand && charts.metric) {
        updateChartAnnotation(charts.demand, price, q);
        updateChartAnnotation(charts.metric, price, metric);
    }
}

function updateChartAnnotation(chart, x, y) {
    chart.options.plugins.annotation.annotations.simLine = { type: 'line', xMin: x, xMax: x, borderColor: '#3b82f6', borderWidth: 2, borderDash: [4,4] };
    chart.options.plugins.annotation.annotations.simPoint = { type: 'point', xValue: x, yValue: y, backgroundColor: '#3b82f6', radius: 6, borderColor: 'white', borderWidth: 2 };
    chart.update('none');
}

function renderCharts(data) {
    const commonOptions = {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false }, annotation: { annotations: {} } },
        scales: { x: { grid: {color:'#30363d'}, title: {display:true, text:'Price'} }, y: { grid: {color:'#30363d'} } }
    };

    if(charts.demand) charts.demand.destroy();
    charts.demand = new Chart(document.getElementById('demandChart'), {
        type: 'line',
        data: {
            labels: data.charts.prices.map(p => p.toFixed(2)),
            datasets: [
                { label: 'Actual', data: data.charts.scatter, type: 'scatter', backgroundColor: '#8b949e' },
                { label: 'Trend', data: data.charts.demand, borderColor: '#fff', borderWidth: 2, pointRadius: 0 },
                { label: 'CI Upper', data: data.charts.demand_upper, backgroundColor: 'rgba(59,130,246,0.1)', borderColor: 'transparent', fill: '+1', pointRadius:0 },
                { label: 'CI Lower', data: data.charts.demand_lower, backgroundColor: 'transparent', borderColor: 'transparent', pointRadius:0 }
            ]
        }, options: commonOptions
    });

    if(charts.metric) charts.metric.destroy();
    charts.metric = new Chart(document.getElementById('metricChart'), {
        type: 'line',
        data: {
            labels: data.charts.prices.map(p => p.toFixed(2)),
            datasets: [{
                label: model.cost > 0 ? 'Profit' : 'Revenue',
                data: data.charts.metric_curve,
                borderColor: '#238636', backgroundColor: 'rgba(35, 134, 54, 0.2)',
                fill: true, pointRadius: 0
            }]
        }, options: commonOptions
    });
}

function animateValue(id, end, prefix="", decimals=0) {
    const el = document.getElementById(id);
    let start = 0; const duration = 1000; const startTime = performance.now();
    function update(currentTime) {
        const elapsed = currentTime - startTime; const progress = Math.min(elapsed / duration, 1);
        const ease = 1 - Math.pow(1 - progress, 4);
        const currentVal = start + (end - start) * ease;
        el.innerText = prefix + currentVal.toLocaleString(undefined, {minimumFractionDigits:decimals, maximumFractionDigits:decimals});
        if (progress < 1) requestAnimationFrame(update);
    }
    requestAnimationFrame(update);
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Price Elasticity Analyzer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --accent: #3b82f6;
      --accent-soft: rgba(59, 130, 246, 0.15);
      --text: #e5e7eb;
      --muted: #9ca3af;
      --danger: #ef4444;
      --success: #22c55e;
    }
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top, #1f2937, #020617);
      color: var(--text);
    }
    .wrapper {
      max-width: 1100px;
      margin: 24px auto;
      padding: 0 16px;
    }
    .header {
      margin-bottom: 20px;
    }
    .title {
      font-size: 1.8rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .badge {
      font-size: 0.75rem;
      color: var(--accent);
      background: var(--accent-soft);
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.3);
    }
    .subtitle {
      color: var(--muted);
      margin-top: 4px;
      font-size: 0.9rem;
    }
    .layout {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 16px;
    }
    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }
    .card {
      background: radial-gradient(circle at top left, #111827, #020617);
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      padding: 16px 18px;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.9);
    }
    .card h2 {
      font-size: 1rem;
      margin: 0 0 10px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .form-group {
      margin-bottom: 12px;
    }
    label {
      display: block;
      margin-bottom: 4px;
      font-size: 0.8rem;
      color: var(--muted);
    }
    input[type="file"],
    input[type="number"],
    select {
      width: 100%;
      padding: 7px 10px;
      border-radius: 8px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: #020617;
      color: var(--text);
      font-size: 0.85rem;
    }
    input[type="file"] {
      padding: 5px;
    }
    input:focus,
    select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
    }
    button {
      width: 100%;
      padding: 8px 12px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(90deg, #3b82f6, #6366f1);
      color: white;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 4px;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .hint {
      font-size: 0.75rem;
      color: var(--muted);
      margin-top: 4px;
    }
    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 10px;
      margin-top: 8px;
    }
    .metric {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 12px;
      padding: 10px;
      border: 1px solid rgba(148, 163, 184, 0.3);
    }
    .metric-label {
      font-size: 0.75rem;
      color: var(--muted);
      margin-bottom: 4px;
    }
    .metric-value {
      font-size: 1.1rem;
      font-weight: 600;
    }
    .metric-tag {
      font-size: 0.7rem;
      margin-top: 2px;
    }
    .metric-tag.elastic {
      color: var(--success);
    }
    .metric-tag.inelastic {
      color: var(--danger);
    }
    .metric-tag.unitary {
      color: var(--accent);
    }
    .status {
      margin-top: 10px;
      font-size: 0.8rem;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: rgba(15, 23, 42, 0.8);
    }
    .status.error {
      border-color: var(--danger);
      color: #fecaca;
      background: rgba(127, 29, 29, 0.4);
    }
    .status.ok {
      border-color: var(--success);
      color: #bbf7d0;
      background: rgba(22, 163, 74, 0.3);
    }
    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: var(--muted);
      margin-left: 4px;
    }
    .section-title {
      font-size: 0.9rem;
      font-weight: 600;
      margin: 16px 0 6px;
    }
    .scenario-text {
      font-size: 0.8rem;
      color: var(--muted);
      line-height: 1.4;
    }
    .scenario-highlight {
      color: var(--accent);
      font-weight: 600;
    }
    .chart {
      width: 100%;
      height: 260px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: rgba(15, 23, 42, 0.8);
      padding: 8px;
      margin-top: 4px;
    }
    canvas {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
<div class="wrapper">
  <div class="header">
    <div class="title">
      Price Elasticity Analyzer
      <span class="badge">Microeconomics · ML</span>
    </div>
    <div class="subtitle">
      Upload sales data, estimate price elasticity, and simulate new pricing scenarios in one simple page.
    </div>
  </div>

  <div class="layout">
    <!-- LEFT: Controls -->
    <div class="card">
      <h2>Inputs <span class="pill">Step 1 → 2</span></h2>

      <form id="analyze-form">
        <div class="form-group">
          <label for="file">Sales CSV <span style="color:#f97316;">*</span></label>
          <input type="file" id="file" name="file" accept=".csv" required />
          <div class="hint">
            Required columns: <code>price</code>, <code>quantity</code>. Optional: <code>product</code>.
          </div>
        </div>

        <div class="form-group">
          <label for="product">Product (optional)</label>
          <select id="product" name="product">
            <option value="ALL">All products</option>
          </select>
          <div class="hint">If your CSV has a 'product' column, you can filter later.</div>
        </div>

        <div class="form-group">
          <label for="test_price">Test price (for scenario)</label>
          <input type="number" step="0.01" min="0" id="test_price" name="test_price" placeholder="e.g. 25" />
        </div>

        <div class="form-group">
          <label for="cost_per_unit">Cost per unit (optional, for profit)</label>
          <input type="number" step="0.01" min="0" id="cost_per_unit" name="cost_per_unit" placeholder="e.g. 15" />
          <div class="hint">Used to estimate profit at the test price.</div>
        </div>

        <button type="submit" id="submit-btn">
          <span id="btn-text">Analyze Elasticity</span>
          <span id="btn-spinner" style="display:none;">⏳</span>
        </button>
      </form>

      <div id="status" class="status" style="display:none;"></div>
    </div>

    <!-- RIGHT: Results -->
    <div class="card">
      <h2>Results & Visuals</h2>

      <div class="metrics">
        <div class="metric">
          <div class="metric-label">Elasticity (b in log‑log)</div>
          <div id="metric-elasticity" class="metric-value">–</div>
          <div id="metric-elasticity-tag" class="metric-tag"></div>
        </div>
        <div class="metric">
          <div class="metric-label">Model R²</div>
          <div id="metric-r2" class="metric-value">–</div>
        </div>
      </div>

      <div id="elasticity-explanation" class="hint" style="margin-top:10px;">
        Upload data to see classification and interpretation here.
      </div>

      <div class="section-title">Scenario summary</div>
      <div id="scenario-summary" class="scenario-text">
        Set a test price to estimate quantity, revenue, and profit.
      </div>

      <div class="section-title">Demand curve (model)</div>
      <div class="chart">
        <canvas id="demand-chart"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js from CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const form = document.getElementById("analyze-form");
  const statusDiv = document.getElementById("status");
  const btn = document.getElementById("submit-btn");
  const btnText = document.getElementById("btn-text");
  const btnSpinner = document.getElementById("btn-spinner");

  const metricElasticity = document.getElementById("metric-elasticity");
  const metricElasticityTag = document.getElementById("metric-elasticity-tag");
  const metricR2 = document.getElementById("metric-r2");
  const explanationDiv = document.getElementById("elasticity-explanation");
  const scenarioDiv = document.getElementById("scenario-summary");

  let demandChart = null;

  function setLoading(isLoading) {
    if (isLoading) {
      btn.disabled = true;
      btnText.style.display = "none";
      btnSpinner.style.display = "inline";
      statusDiv.style.display = "block";
      statusDiv.className = "status";
      statusDiv.textContent = "Analyzing… please wait.";
    } else {
      btn.disabled = false;
      btnText.style.display = "inline";
      btnSpinner.style.display = "none";
    }
  }

  function setStatus(message, isError = false) {
    statusDiv.style.display = "block";
    statusDiv.textContent = message;
    statusDiv.className = "status " + (isError ? "error" : "ok");
  }

  function updateMetrics(data) {
    metricElasticity.textContent = data.elasticity.toFixed(2);
    metricR2.textContent = data.r2.toFixed(2);

    const absE = Math.abs(data.elasticity);
    let tagText = data.classification;
    let tagClass = "metric-tag ";

    if (data.classification === "Elastic") {
      tagClass += "elastic";
    } else if (data.classification === "Inelastic") {
      tagClass += "inelastic";
    } else {
      tagClass += "unitary";
    }

    metricElasticityTag.textContent = tagText;
    metricElasticityTag.className = tagClass;
    explanationDiv.textContent = data.explanation;
  }

  function updateScenario(scenario) {
    if (!scenario) {
      scenarioDiv.innerHTML = "Set a test price to estimate quantity, revenue, and profit.";
      return;
    }
    let html = "";
    html += `At price <span class="scenario-highlight">${scenario.test_price.toFixed(2)}</span>, `;
    html += `predicted quantity is about <span class="scenario-highlight">${scenario.predicted_quantity.toFixed(0)}</span> units. `;
    html += `Revenue ≈ <span class="scenario-highlight">${scenario.predicted_revenue.toFixed(2)}</span>. `;
    if (scenario.predicted_profit !== null) {
      html += `Estimated profit ≈ <span class="scenario-highlight">${scenario.predicted_profit.toFixed(2)}</span>. `;
    }
    html += `<br/>Compared to average historical price ${scenario.baseline_price.toFixed(2)}, `;
    const sign = scenario.revenue_change_pct >= 0 ? "+" : "";
    html += `revenue change is <span class="scenario-highlight">${sign}${scenario.revenue_change_pct.toFixed(1)}%</span>.`;
    scenarioDiv.innerHTML = html;
  }

  function renderChart(scatterData, curveData) {
    const ctx = document.getElementById("demand-chart").getContext("2d");

    if (demandChart) {
      demandChart.destroy();
    }

    demandChart = new Chart(ctx, {
      type: "scatter",
      data: {
        datasets: [
          {
            label: "Actual data",
            data: scatterData.map(pt => ({ x: pt.price, y: pt.quantity })),
            backgroundColor: "rgba(96, 165, 250, 0.9)",
            pointRadius: 3
          },
          {
            label: "Fitted demand curve",
            data: curveData.map(pt => ({ x: pt.price, y: pt.quantity_pred })),
            type: "line",
            borderColor: "rgba(52, 211, 153, 1)",
            borderWidth: 2,
            tension: 0.15,
            pointRadius: 0
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: { color: "#e5e7eb", font: { size: 10 } }
          }
        },
        scales: {
          x: {
            title: { display: true, text: "Price", color: "#9ca3af" },
            ticks: { color: "#9ca3af" },
            grid: { color: "rgba(31,41,55,0.8)" }
          },
          y: {
            title: { display: true, text: "Quantity", color: "#9ca3af" },
            ticks: { color: "#9ca3af" },
            grid: { color: "rgba(31,41,55,0.8)" }
          }
        }
      }
    });
  }

  form.addEventListener("submit", function (e) {
    e.preventDefault();
    const fileInput = document.getElementById("file");
    if (!fileInput.files.length) {
      setStatus("Please select a CSV file.", true);
      return;
    }

    const formData = new FormData(form);
    setLoading(true);

    fetch("/analyze", {
      method: "POST",
      body: formData
    })
      .then(res => res.json().then(body => ({ status: res.status, body })))
      .then(result => {
        setLoading(false);
        if (result.status !== 200) {
          setStatus(result.body.error || "Unknown error.", true);
          return;
        }
        setStatus("Analysis completed successfully.", false);
        updateMetrics(result.body);
        updateScenario(result.body.scenario);
        renderChart(result.body.scatter_data, result.body.curve_data);
      })
      .catch(err => {
        setLoading(false);
        setStatus("Request failed: " + err.message, true);
      });
  });
</script>
</body>
</html>
